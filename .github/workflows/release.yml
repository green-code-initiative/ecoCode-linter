name: Release & Publish

on:
  workflow_dispatch:
    inputs:
      linter:
        description: 'Linter package to release'
        required: true
        type: choice
        options:
          - eslint-plugin

permissions:
  contents: write
  packages: write

jobs:
  checks:
    name: Requirements
    runs-on: ubuntu-latest
    steps:
      - name: Check user permissions
        uses: 74th/workflow-permission-action@1.0.0
        with:
          users: dedece35,glalloue,jhertout,jules-delecour-dav,olegoaer,zippy1978,utarwyn

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: checks
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Apply version
        run: yarn version apply
        working-directory: ${{ inputs.linter }}

      - name: Get package version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@main
        with:
          path: ${{ inputs.linter }}

      - name: Check tag non-existence
        run: if git show-ref --tags --verify --quiet -- "refs/tags/${{ inputs.linter }}/${{ steps.package-version.outputs.current-version }}"; then echo "::error::Tag already exists" && exit 1; fi

      - name: Extract release notes
        id: extract-release-notes
        uses: ffurrer2/extract-release-notes@v1
        with:
          changelog_file: ${{ inputs.linter }}/CHANGELOG.md
          prerelease: true

      - name: Update changelog
        uses: thomaseizinger/keep-a-changelog-new-release@v1
        with:
          tag: ${{ inputs.linter }}/${{ steps.package-version.outputs.current-version }}
          changelogPath: ${{ inputs.linter }}/CHANGELOG.md

      - name: Commit new version
        uses: EndBug/add-and-commit@v9
        with:
          message: Bump ${{ inputs.linter }} to ${{ steps.package-version.outputs.current-version }}
          default_author: github_actions

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ inputs.linter }} ${{ steps.package-version.outputs.current-version }}
          tag_name: ${{ inputs.linter }}/${{ steps.package-version.outputs.current-version }}
          body: ${{ steps.extract-release-notes.outputs.release_notes }}

  publish-npm:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Copy LICENSE
        run: cp LICENSE.md ${{ inputs.linter }}/

      - name: Publish package on NPM
        run: npm publish --access public --workspace ${{ inputs.linter }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-github:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: yarn install --immutable

      - name: Copy LICENSE
        run: cp LICENSE.md ${{ inputs.linter }}/

      - name: Add scope to package name
        run: npx --workspace ${{ inputs.linter }} --yes change-package-name @${{ github.repository_owner }}/ecocode-${{ inputs.linter }}

      - name: Configure GitHub Packages registry
        uses: bduff9/use-npmrc@v2.0.0
        with:
          dot-npmrc: |
            //npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}
            @${{ github.repository_owner }}:registry=https://npm.pkg.github.com
            always-auth=true
          working-directory: ${{ inputs.linter }}

      - name: Publish package on GitHub Packages
        run: npm publish --workspace ${{ inputs.linter }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
